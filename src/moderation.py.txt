from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CommandHandler, CallbackQueryHandler
from database import Database
import logging

logger = logging.getLogger(__name__)

async def moderate_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–∞–Ω–µ–ª—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤"""
    user = update.effective_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    chat_member = await context.bot.get_chat_member(update.effective_chat.id, user.id)
    if chat_member.status not in ['creator', 'administrator']:
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    conn = Database.get_connection()
    try:
        with conn.cursor() as cur:
            # –û–∂–∏–¥–∞—é—â–∏–µ –∂–∞–ª–æ–±—ã
            cur.execute('''
                SELECT COUNT(*) FROM reports 
                WHERE chat_id = %s AND status = 'pending'
            ''', (update.effective_chat.id,))
            pending_reports = cur.fetchone()[0]
            
            # –ê–∫—Ç–∏–≤–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
            cur.execute('''
                SELECT COUNT(*) FROM votes 
                WHERE chat_id = %s AND is_active = TRUE
            ''', (update.effective_chat.id,))
            active_votes = cur.fetchone()[0]
            
            # –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            cur.execute('''
                SELECT COUNT(*) FROM users 
                WHERE is_banned = TRUE
            ''')
            banned_users = cur.fetchone()[0]
            
            # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∂–∞–ª–æ–±—ã
            cur.execute('''
                SELECT r.report_id, u.username, r.reason, r.created_at
                FROM reports r
                JOIN users u ON r.reported_user_id = u.user_id
                WHERE r.chat_id = %s AND r.status = 'pending'
                ORDER BY r.created_at DESC
                LIMIT 5
            ''', (update.effective_chat.id,))
            
            recent_reports = cur.fetchall()
    finally:
        Database.return_connection(conn)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–∞–Ω–µ–ª–∏
    panel_text = f"""
üõ°Ô∏è <b>–ü–ê–ù–ï–õ–¨ –ú–û–î–ï–†–ê–¶–ò–ò</b>

üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚îú ‚è≥ –ñ–∞–ª–æ–± –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏: {pending_reports}
‚îú üó≥Ô∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π: {active_votes}
‚îú üö´ –ó–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {banned_users}
‚îî üë§ –í–∞—à —É—Ä–æ–≤–µ–Ω—å: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

üìã <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∂–∞–ª–æ–±—ã:</b>
"""
    
    for report_id, username, reason, created_at in recent_reports:
        time_ago = "—Ç–æ–ª—å–∫–æ —á—Ç–æ"  # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
        panel_text += f"‚îú #{report_id}: @{username} - {reason} ({time_ago})\n"
    
    if not recent_reports:
        panel_text += "‚îî –ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∂–∞–ª–æ–±\n"
    
    panel_text += "\n‚öôÔ∏è <b>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</b>"
    
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–∞–Ω–µ–ª–∏
    keyboard = [
        [
            InlineKeyboardButton("üì® –û–∂–∏–¥–∞—é—â–∏–µ –∂–∞–ª–æ–±—ã", callback_data="mod:pending_reports"),
            InlineKeyboardButton("üó≥Ô∏è –ê–∫—Ç–∏–≤–Ω—ã–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è", callback_data="mod:active_votes")
        ],
        [
            InlineKeyboardButton("üö´ –°–ø–∏—Å–æ–∫ –±–∞–Ω–æ–≤", callback_data="mod:ban_list"),
            InlineKeyboardButton("‚ö†Ô∏è –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ", callback_data="mod:issue_warning")
        ],
        [
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞", callback_data="mod:chat_stats"),
            InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="mod:refresh")
        ],
        [
            InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="mod:settings"),
            InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="mod:close")
        ]
    ]
    
    await update.message.reply_text(
        panel_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='HTML'
    )

async def handle_moderation_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤ –ø–∞–Ω–µ–ª–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏"""
    query = update.callback_query
    await query.answer()
    
    data = query.data.split(":")
    action = data[1]
    
    if action == "pending_reports":
        await show_pending_reports(query, context)
    elif action == "active_votes":
        await show_active_votes(query, context)
    elif action == "ban_list":
        await show_ban_list(query, context)
    elif action == "refresh":
        await query.delete_message()
        await moderate_panel(update, context)
    elif action == "close":
        await query.delete_message()

async def show_pending_reports(query, context):
    """–ü–æ–∫–∞–∑–∞—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –∂–∞–ª–æ–±—ã"""
    conn = Database.get_connection()
    try:
        with conn.cursor() as cur:
            cur.execute('''
                SELECT r.report_id, r.reason, r.report_type, 
                       u1.username as reporter, u2.username as reported,
                       r.created_at, r.message_id
                FROM reports r
                JOIN users u1 ON r.reporter_id = u1.user_id
                JOIN users u2 ON r.reported_user_id = u2.user_id
                WHERE r.chat_id = %s AND r.status = 'pending'
                ORDER BY r.created_at DESC
                LIMIT 10
            ''', (query.message.chat_id,))
            
            reports = cur.fetchall()
    finally:
        Database.return_connection(conn)
    
    if not reports:
        await query.edit_message_text(
            text="üì≠ –ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∂–∞–ª–æ–±",
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="mod:refresh")
            ]])
        )
        return
    
    text = "üì® <b>–û–ñ–ò–î–ê–Æ–©–ò–ï –ñ–ê–õ–û–ë–´</b>\n\n"
    
    keyboard = []
    for report in reports:
        report_id, reason, report_type, reporter, reported, created_at, message_id = report
        text += f"<b>#{report_id}</b> | {report_type.upper()}\n"
        text += f"üë§ –û—Ç: @{reporter}\n"
        text += f"üë• –ù–∞: @{reported}\n"
        text += f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
        text += f"üïê {created_at.strftime('%H:%M %d.%m')}\n"
        text += "‚îÄ" * 30 + "\n"
        
        keyboard.append([
            InlineKeyboardButton(f"üëÅÔ∏è #{report_id}", callback_data=f"mod:view_report:{report_id}"),
            InlineKeyboardButton(f"‚öñÔ∏è –ì–æ–ª–æ—Å–æ–≤–∞—Ç—å", callback_data=f"mod:vote_on:{report_id}"),
            InlineKeyboardButton(f"‚úÖ –†–µ—à–∏—Ç—å", callback_data=f"mod:resolve:{report_id}")
        ])
    
    keyboard.append([InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="mod:refresh")])
    
    await query.edit_message_text(
        text=text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='HTML'
    )

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
def add_moderation_handlers(application):
    """–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏"""
    application.add_handler(CommandHandler("moderate", moderate_panel))
    application.add_handler(CommandHandler("mod", moderate_panel))
    application.add_handler(CallbackQueryHandler(handle_moderation_callback, pattern="^mod:"))